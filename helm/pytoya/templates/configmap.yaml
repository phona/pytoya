{{- $ns := default .Release.Namespace .Values.global.namespace -}}
{{- $dbHost := default (printf "%s-postgres" (include "pytoya.fullname" .)) .Values.api.env.DB_HOST -}}
{{- $dbPort := default (printf "%v" .Values.postgres.service.port) .Values.api.env.DB_PORT -}}
{{- $dbUsername := default .Values.postgres.auth.username .Values.api.env.DB_USERNAME -}}
{{- $dbDatabase := default .Values.postgres.auth.database .Values.api.env.DB_DATABASE -}}
{{- $redisHost := default (printf "%s-redis" (include "pytoya.fullname" .)) .Values.api.env.REDIS_HOST -}}
{{- $redisPort := default (printf "%v" .Values.redis.service.port) .Values.api.env.REDIS_PORT -}}
{{- $apiPort := default "3000" .Values.api.env.PORT -}}
{{- $webApiBaseUrl := default "/api" .Values.web.env.VITE_API_URL -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pytoya.fullname" . }}-config
  namespace: {{ $ns }}
  labels:
    {{- include "pytoya.labels" . | nindent 4 }}
data:
  config.yaml: |
    server:
      nodeEnv: {{ .Values.api.env.NODE_ENV | quote }}
      port: {{ $apiPort }}
    database:
      host: {{ $dbHost | quote }}
      port: {{ $dbPort }}
      username: {{ $dbUsername | quote }}
      password: {{ .Values.postgres.auth.password | quote }}
      database: {{ $dbDatabase | quote }}
    redis:
      host: {{ $redisHost | quote }}
      port: {{ $redisPort }}
    jwt:
      secret: {{ .Values.secrets.jwtSecret | quote }}
      expiration: 7d
    paddleocr:
      baseUrl: {{ .Values.api.env.PADDLEOCR_BASE_URL | quote }}
    llm:
      apiKey: {{ .Values.secrets.llmApiKey | quote }}
  # Web env vars (remain as-is for frontend build)
  VITE_API_URL: {{ $webApiBaseUrl | quote }}

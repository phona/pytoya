{{- $ns := default .Release.Namespace .Values.global.namespace -}}
{{- $fullname := include "pytoya.fullname" . -}}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullname }}-config
  namespace: {{ $ns }}
  labels:
    {{- include "pytoya.labels" . | nindent 4 }}
data:
  config.yaml: |
    server:
      port: {{ .Values.api.config.server.port }}
      logLevel: {{ .Values.api.config.server.logLevel }}
      basePath: {{ include "pytoya.basePath" . | quote }}
    database:
      host: {{ .Values.api.config.database.host | quote }}
      port: {{ .Values.api.config.database.port }}
      username: {{ .Values.api.config.database.username | quote }}
      password: "{{ "{{DB_PASSWORD}}" }}"
      database: {{ .Values.api.config.database.database | quote }}
    redis:
      host: {{ .Values.api.config.redis.host | quote }}
      port: {{ .Values.api.config.redis.port }}
    queue:
      extraction:
        concurrency: {{ .Values.api.config.queue.extraction.concurrency | default 5 }}
    jwt:
      secret: "{{ "{{JWT_SECRET}}" }}"
      expiration: {{ .Values.api.config.jwt.expiration | default "7d" | quote }}
    paddleocr:
      baseUrl: {{ .Values.api.config.paddleocr.baseUrl | quote }}
    features:
      manualExtraction: {{ .Values.api.config.features.manualExtraction | default true }}
    security:
      cors:
        enabled: {{ .Values.api.config.security.cors.enabled | default true }}
        allowedOrigins:
        {{- range .Values.api.config.security.cors.allowedOrigins }}
          - {{ . | quote }}
        {{- end }}
        credentials: {{ .Values.api.config.security.cors.credentials | default true }}
        methods:
        {{- range .Values.api.config.security.cors.methods }}
          - {{ . | quote }}
        {{- end }}
        allowedHeaders:
        {{- range .Values.api.config.security.cors.allowedHeaders }}
          - {{ . | quote }}
        {{- end }}
      rateLimit:
        enabled: {{ .Values.api.config.security.rateLimit.enabled | default true }}
        ttl: {{ .Values.api.config.security.rateLimit.ttl | default 60000 }}
        limit: {{ .Values.api.config.security.rateLimit.limit | default 120 }}
        storage: {{ .Values.api.config.security.rateLimit.storage | default "memory" | quote }}
      accountLockout:
        enabled: {{ .Values.api.config.security.accountLockout.enabled | default true }}
        thresholds:
        {{- range .Values.api.config.security.accountLockout.thresholds }}
          - attempts: {{ .attempts }}
            {{- if .duration }}
            duration: {{ .duration }}
            {{- end }}
            {{- if .permanent }}
            permanent: {{ .permanent }}
            {{- end }}
        {{- end }}
      passwordPolicy:
        minLength: {{ .Values.api.config.security.passwordPolicy.minLength }}
        maxLength: {{ .Values.api.config.security.passwordPolicy.maxLength }}
        requireUppercase: {{ .Values.api.config.security.passwordPolicy.requireUppercase }}
        requireLowercase: {{ .Values.api.config.security.passwordPolicy.requireLowercase }}
        requireNumber: {{ .Values.api.config.security.passwordPolicy.requireNumber }}
        requireSpecialChar: {{ .Values.api.config.security.passwordPolicy.requireSpecialChar }}
        specialChars: {{ .Values.api.config.security.passwordPolicy.specialChars | quote }}
      usernamePolicy:
        minLength: {{ .Values.api.config.security.usernamePolicy.minLength }}
        maxLength: {{ .Values.api.config.security.usernamePolicy.maxLength }}
        pattern: {{ .Values.api.config.security.usernamePolicy.pattern | quote }}
